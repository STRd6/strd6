<html>
  <head>
    <script src="jquery-1.3.2.js"></script>
    <script src="power_canvas.jquery.js"></script>
    <script src="strd6.js"></script>
    <script src="sprites.strd6.js"></script>
  </head>
  <body style="overflow: hidden;">
    <canvas id="canvas" width="300" height="300">
      <p> Get a better browser</p>
    </canvas>
    <div id="panel" class="btn-slide" style="width: 300px; height:20px; background-color:black; cursor:pointer;"></div>
    <div id="inventoryBox" class="btn-slide" style="width:40px; height:10px; background-color:black; cursor:pointer; visibility:visible;">
      <div id="inventoryText" style="font-size:9px; text-align:center; color:white; cursor:pointer; visibility:visible;">inventory</div>
    </div>

    <img id="sprite" src="earthbound1.png" alt="earthbound"/>
    <img id="slashes" src="slashes.png" alt="chrono slashes"/>
    <img id="damageFont" src="damage_font.png" alt="damage font"/>
    <img id="brick" src="brick.png" alt="brick"/>

    <script>
      function loadSpriteData(url, callback) {
        $.getJSON(url, function(data) {
          var img = new Image();
          img.src = data.file;

          var size = data.size;
          var tileWidth = size || data.tileWidth;
          var tileHeight = size || data.tileHeight;
          var width = img.width;
          var height = img.height;
          var rows = Math.floor(height / tileHeight);
          var cols = Math.floor(width / tileWidth);

          var tiles = [];

          for(var row = 0; row < rows; row++) {
            for(var col = 0; col < cols; col++) {
              tiles[tiles.length] = Tile(img, col * tileWidth, row * tileHeight, tileWidth, tileHeight);
            }
          }

          var composites = [];
          if(data.composites) {
            for(var i = 0; i < data.composites.length; i++) {
              var dataComposite = data.composites[i];

              composites[i] = Composite(dataComposite.map(function(tileDatum) {
                return {tile: tiles[tileDatum.tile], x: tileDatum.x, y: tileDatum.y};
              }));
            }
          }

          var characters = {};
          if(data.characters) {
            $.each(data.characters, function(name, row) {
              var animations = {};
              if(data.animations) {
                $.each(data.animations, function(name, animationTiles) {
                  animations[name] = Animation(animationTiles.map(function(n){ return tiles[n + row * cols] }));
                });
              }

              characters[name] = animations;
            });
          }

          callback({
            tiles: tiles,
            composites: composites,
            characters: characters
          });
        });
      }

      var inventoryToggle = 0;
      
      $(function() {
        $(".btn-slide").click(function(){
          $("#panel").slideToggle("fast");
          inventoryToggle += 1;
          inventoryToggle = inventoryToggle % 2;
          if (inventoryToggle == 1) {
            document.getElementById("inventoryBox").style.visibility = "visible";
            document.getElementById("inventoryText").style.visibility = "visible"; 
          } else if (inventoryToggle == 0) {
            document.getElementById("inventoryBox").style.visibility = "hidden";
            document.getElementById("inventoryText").style.visibility = "hidden";          
          }
          $(this).toggleClass("active");
        });

        var slashSheet = $("#slashes").get(0);
        var spriteSheet = $("#sprite").get(0);
        var damageSheet = $("#damageFont").get(0);
        var brickImage = $("#brick").get(0);

        var nullTile = Tile(damageSheet, 0, 0, 8, 8);
      
        var canvas;
        var action = "default";

        var Action = {
          RIGHT: 'walkRight',
          LEFT: 'walkLeft',
          UP: 'walkUp',
          DOWN: 'walkDown',
          TELEPORT: 'teleport',
          ATTACK: 'attack'
        };

        var actors = (function() {
          var x = 25;
          var y = 25;

          function changePosition(byX, byY) {
            x += byX;
            y += byY;
          }

          function newPosition(newX, newY) {
            x = newX;
            y = newY;
          }

          function loadActor(name, moveSpeed) {
            var states = {};

            states[Action.TELEPORT] = Animation([
              Tile(spriteSheet, 8 + 2*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 6*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 10*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
              Tile(spriteSheet, 8 + 14*18, 16, 18, 28)
            ]);
            states[Action.ATTACK] = Animation([
              Composite([
                {tile: Tile(spriteSheet, 8 + 2*18, 16, 18, 28), x: 0, y: 0},
                {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
              ])
            ]);

            loadSpriteData('earthbound_characters.tilemap.json', function(data) {
              $.each(data.characters[name], function(key, value) {
                states[key] = value;
              });

              states['default'] = data.characters[name].standDown;
            });

            return Actor(states, "default", {
              update: function(state) {
                this.state(action);

                switch(action) {
                  case Action.RIGHT:
                    changePosition(moveSpeed, 0);
                    states['default'] = states.standRight;
                    states[Action.ATTACK] = Animation([
                      Composite([
                        {tile: Tile(spriteSheet, 8 + 13*18, 16, 18, 28), x: 0, y: 0},
                        {tile: Tile(slashSheet, 0, 16, 16, 16), x: 10, y: 4},
                        {tile: Tile(slashSheet, 16, 16, 16, 16), x: 10, y: 20}
                      ])
                    ]);
                    break;
                  case Action.LEFT:
                    changePosition(-moveSpeed, 0);
                    states['default'] = states.standLeft;
                    states[Action.ATTACK] = Animation([
                      Composite([
                        {tile: Tile(spriteSheet, 8 + 4*18, 16, 18, 28), x: 0, y: 0},
                        {tile: Tile(slashSheet, 0, 16, 16, 16), x: -9, y: 4},
                        {tile: Tile(slashSheet, 16, 16, 16, 16), x: -9, y: 20}
                      ])
                    ]);
                    break;
                  case Action.UP:
                    changePosition(0, -moveSpeed);
                    states['default'] = states.standUp;
                    states[Action.ATTACK] = Animation([
                      Composite([
                        {tile: Tile(spriteSheet, 8 + 8*18, 16, 18, 28), x: 0, y: 0},
                        {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                        {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                      ])
                    ]);
                    break;
                  case Action.DOWN:
                    changePosition(0, moveSpeed);
                    states['default'] = states.standDown;
                    states[Action.ATTACK] = Animation([
                      Composite([
                        {tile: Tile(spriteSheet, 8 + 0*18, 16, 18, 28), x: 0, y: 0},
                        {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                        {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                      ])
                    ]);
                    break;
                  case Action.TELEPORT:
                    newPosition(rand(280), rand(280));
                    break;
                  case Action.ATTACK:
                    changePosition(0, 0);
                    break;
                }
              },

              draw: function(canvas, options) {
                (states[this.state()] || nullTile).draw(canvas, x, y, options);
              }
            });
          }

          return {
            Ness: loadActor("Ness", 4),
            Kid: loadActor("Kid", 3),
            Jeff: loadActor("Jeff", 6),
            Girl: loadActor("Girl", 4),
            Pu: loadActor("Pu", 5),
          }
        })();

        var loadedAnimation = {};

        loadSpriteData("earthbound_characters.tilemap.json", function(data) {
          loadedAnimation = data.characters.Kid.walkLeft;
        });

        var loadedComposites = [];
        loadSpriteData("slashes.tilemap.json", function(data) {
          loadedComposites = data.composites;
        });

        var damageNumbers = (function() {
          var font = $("#damageFont").get(0);
          var nums = [];
          var size = 8

          // 0-9
          for(var i = 0; i <= 9; i++) {
            nums[i] = Tile(font, i * size, 0, size, size);
          }

          // MISS
          nums[i] = Tile(font, i * size, 0, 2*size, size);

          return nums;
        })();

        function damageToGraphic(damage) {
          var tiles = [];
          var pos = 0;
          var size = 8;

          while(damage > 0) {
            tiles.push({tile: damageNumbers[damage%10], x: pos*size, y: 0})
            damage = Math.floor(damage/10);
            pos--;
          }
          
          return Composite(tiles);
        }

        /*
        Sprite = function(image, baseX, baseY, cellWidth, cellHeight, frameCount)
        */
        var testSprites = [
          actors.Ness,
          actors.Kid,
          actors.Jeff,
          actors.Girl,
          actors.Pu,
          damageToGraphic(rand(999))
        ];

        var ts = 0;

        var tiledBackground = (function(img, tileWidth, tileHeight, bgWidth, bgHeight) {

          var tileData = [];

          for(var row = 0; row < bgHeight / tileHeight; row++) {
            for(var col = 0; col < bgWidth / tileWidth; col++) {
              tileData.push({
                tile: Tile(img, 0, 0, tileWidth, tileHeight),
                x: col * tileWidth,
                y: row * tileHeight
              });
            }
          }

          return Composite(tileData);
        })(brickImage, 32, 32, 320, 320);
		
        $('canvas').powerCanvas({init: function(_canvas) {
          canvas = _canvas;

          setInterval(function() {
            canvas.clear();
            tiledBackground.draw(canvas, 0, 0);

            // Gather Input


            testSprites[ts].draw(canvas, 50, 50);
            testSprites[ts].update();

            $.each(damageNumbers, function(i, damageNumber) {
              damageNumber.draw(canvas, 75 + 8*i, 8);
            });

            $.each(loadedComposites, function(i, composite) {
              composite.draw(canvas, (i%4) * 32, Math.floor(i/4) * 32);
            });

            if(loadedAnimation) {
              loadedAnimation.update();
              loadedAnimation.draw(canvas, 100, 190);
            }

          }, 100);
        }});
        
        $(document).keydown(function(e) {
          console.log(e);

          if(e.keyCode == 39) {
            action = Action.RIGHT;
          } else if(e.keyCode == 37) {
            action = Action.LEFT;
          } else if(e.keyCode == 38) {
            action = Action.UP;
          } else if (e.keyCode == 40) {
            action = Action.DOWN;
          } else if (e.keyCode == 13) {
            action = Action.ATTACK;
          } else if (e.keyCode == 8 || e.keyCode == 84) {
            action = Action.TELEPORT;
          }

          if(e.keyCode == 107) {
            ts++;
          } else if(e.keyCode == 109) {
            ts--;
          }
        });

        $(document).keyup(function(e) {
          action = "default";
        });
      });
    </script> 
  </body>
</html>
