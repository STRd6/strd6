<html>
  <head>
    <script src="jquery-1.3.2.js"></script>
    <script src="power_canvas.jquery.js"></script>
    <script src="strd6.js"></script>
    <script src="sprites.strd6.js"></script>
  </head>
  <body style="overflow: hidden;">
    <canvas id="canvas" width="300" height="300">
      <p> Get a better browser</p>
    </canvas>
    <div id="panel" class="btn-slide" style="width: 300px; height:20px; background-color:black; cursor:pointer;"></div>
    <div id="inventoryBox" class="btn-slide" style="width:40px; height:10px; background-color:black; cursor:pointer; visibility:visible;">
      <div id="inventoryText" style="font-size:9px; text-align:center; color:white; cursor:pointer; visibility:visible;">inventory</div>
    </div>
    
    <img id="sprite" src="earthbound1.png" alt="earthbound"/>
    <img id="slashes" src="slashes.png" alt="chrono slashes"/>
    <img id="damageFont" src="damage_font.png" alt="damage font"/>

    <script>
      function loadSpriteData(url, callback) {
        $.getJSON(url, function(data) {
          var img = new Image();
          img.src = data.file;

          var size = data.size;
          var width = img.width;
          var height = img.height;
          var rows = Math.floor(height / size);
          var cols = Math.floor(width / size);

          var tiles = [];

          for(var row = 0; row < rows; row++) {
            for(var col = 0; col < cols; col++) {
              tiles[tiles.length] = Tile(img, col * size, row * size, size, size);
            }
          }

          var composites = [];

          for(var i = 0; i < data.composites.length; i++) {
            var dataComposite = data.composites[i];

            composites[i] = Composite(dataComposite.map(function(tileDatum) {
              return {tile: tiles[tileDatum.tile], x: tileDatum.x, y: tileDatum.y};
            }));
          }

          callback(tiles, composites);
        });
      }

      var inventoryToggle = 0;
      
      $(function() {
        $(".btn-slide").click(function(){
          $("#panel").slideToggle("fast");
          inventoryToggle += 1;
          inventoryToggle = inventoryToggle % 2;
          if (inventoryToggle == 1) {
            document.getElementById("inventoryBox").style.visibility = "visible";
            document.getElementById("inventoryText").style.visibility = "visible"; 
          } else if (inventoryToggle == 0) {
            document.getElementById("inventoryBox").style.visibility = "hidden";
            document.getElementById("inventoryText").style.visibility = "hidden";          
          }
          $(this).toggleClass("active");
        });
      
        var canvas;
        var action = "default";

        var Action = {
          RIGHT: 'r',
          LEFT: 'l',
          UP: 'u',
          DOWN: 'd',
          TELEPORT: 't',
          ATTACK: 'a'
        };

        var slashSheet = $("#slashes").get(0);
        var spriteSheet = $("#sprite").get(0);

        var nessAnimation = (function() {
          var tiles = [];
          var tileWidth = 18;
          var tileHeight = 28;

          for(var i = 0; i < 16; i++) {
            // Double to slow frame rate
            tiles[tiles.length] = Tile(spriteSheet, 8 + i*18, 16, tileWidth, tileHeight);
            tiles[tiles.length] = Tile(spriteSheet, 8 + i*18, 16, tileWidth, tileHeight);
          }

          return Animation(tiles);
        })();

        var nessActor = (function() {
          var moveSpeed = 4;

          var states = {};
          states['default'] = Tile(spriteSheet, 8 + 2*18, 16, 18, 28);
          states[Action.LEFT] = Animation([
            Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 16, 18, 28)
          ]);
          states[Action.RIGHT] = Animation([
            Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 16, 18, 28)
          ]);
          states[Action.UP] = Animation([
            Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 16, 18, 28)
          ]);
          states[Action.DOWN] = Animation([
            Tile(spriteSheet, 8 + 0*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 0*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 16, 18, 28)
          ]);
          states[Action.TELEPORT] = Animation([
            Tile(spriteSheet, 8 + 2*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 6*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 10*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 14*18, 16, 18, 28)
          ]);
          states[Action.ATTACK] = Animation([
            Composite([
              {tile: Tile(spriteSheet, 8 + 2*18, 16, 18, 28), x: 0, y: 0},
              {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
              {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
            ])
          ]);


          return Actor(states, "default", 25, 25, function(state) {
            this.state(action);

            switch(action) {
              case Action.RIGHT:
                this.changePosition(moveSpeed, 0);
                states['default'] = Tile(spriteSheet, 8 + 13*18, 16, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 13*18, 16, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 10, y: 4},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 10, y: 20}
                  ])
                ]);
                break;
              case Action.LEFT:
                this.changePosition(-moveSpeed, 0);
                states['default'] = Tile(spriteSheet, 8 + 4*18, 16, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 4*18, 16, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: -9, y: 4},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: -9, y: 20}
                  ])
                ]);
                break;
              case Action.UP:
                this.changePosition(0, -moveSpeed);
                states['default'] = Tile(spriteSheet, 8 + 8*18, 16, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 8*18, 16, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                  ])
                ]);
                break;
              case Action.DOWN:
                this.changePosition(0, moveSpeed);
                states['default'] = Tile(spriteSheet, 8 + 0*18, 16, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 0*18, 16, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                  ])
                ]);
                break;
              case Action.TELEPORT:
                this.newPosition(rand(280), rand(280));
                break;
              case Action.ATTACK:
                this.changePosition(0, 0);
                break;
            }
          });
        })();

        var jeffActor = (function() {
          var moveSpeed = 6;

          var states = {};
          states['default'] = Tile(spriteSheet, 8 + 2*18, 100, 18, 28);
          states[Action.LEFT] = Animation([
            Tile(spriteSheet, 8 + 4*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 4*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 100, 18, 28)
          ]);
          states[Action.RIGHT] = Animation([
            Tile(spriteSheet, 8 + 12*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 12*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 100, 18, 28)
          ]);
          states[Action.UP] = Animation([
            Tile(spriteSheet, 8 + 8*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 8*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 100, 18, 28)
          ]);
          states[Action.DOWN] = Animation([
            Tile(spriteSheet, 8 + 0*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 0*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 100, 18, 28)
          ]);
          states[Action.TELEPORT] = Animation([
            Tile(spriteSheet, 8 + 2*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 4*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 6*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 8*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 10*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 12*18, 100, 18, 28),
            Tile(spriteSheet, 8 + 14*18, 100, 18, 28)
          ]);
          states[Action.ATTACK] = Animation([
            Composite([
              {tile: Tile(spriteSheet, 8 + 2*18, 100, 18, 28), x: 0, y: 0},
              {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
              {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
            ])
          ]);


          return Actor(states, "default", 25, 25, function(state) {
            this.state(action);

            switch(action) {
              case Action.RIGHT:
                this.changePosition(moveSpeed, 0);
                states['default'] = Tile(spriteSheet, 8 + 13*18, 100, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 13*18, 100, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 10, y: 4},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 10, y: 20}
                  ])
                ]);
                break;
              case Action.LEFT:
                this.changePosition(-moveSpeed, 0);
                states['default'] = Tile(spriteSheet, 8 + 4*18, 100, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 4*18, 100, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: -9, y: 4},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: -9, y: 20}
                  ])
                ]);
                break;
              case Action.UP:
                this.changePosition(0, -moveSpeed);
                states['default'] = Tile(spriteSheet, 8 + 8*18, 100, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 8*18, 100, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                  ])
                ]);
                break;
              case Action.DOWN:
                this.changePosition(0, moveSpeed);
                states['default'] = Tile(spriteSheet, 8 + 0*18, 100, 18, 28);
                states[Action.ATTACK] = Animation([
                  Composite([
                    {tile: Tile(spriteSheet, 8 + 0*18, 100, 18, 28), x: 0, y: 0},
                    {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
                    {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
                  ])
                ]);
                break;
              case Action.TELEPORT:
                this.newPosition(rand(280), rand(280));
                break;
              case Action.ATTACK:
                this.changePosition(0, 0);
                break;
            }
          });
        })();

        var loadedComposites = [];
        var loadedTiles = [];

        loadSpriteData("slashes.tilemap.json", function(tiles, composites) {
          loadedComposites = composites;
          loadedTiles = tiles;
        });

        var damageNumbers = (function() {
          var font = $("#damageFont").get(0);
          var nums = [];
          var size = 8

          // 0-9
          for(var i = 0; i <= 9; i++) {
            nums[i] = Tile(font, i * size, 0, size, size);
          }

          // MISS
          nums[i] = Tile(font, i * size, 0, 2*size, size);

          return nums;
        })();

        function damageToGraphic(damage) {
          var tiles = [];
          var pos = 0;
          var size = 8;

          while(damage > 0) {
            tiles.push({tile: damageNumbers[damage%10], x: pos*size, y: 0})
            damage = Math.floor(damage/10);
            pos--;
          }
          
          return Composite(tiles);
        }

        /*
        Sprite = function(image, baseX, baseY, cellWidth, cellHeight, frameCount)
        */
        var testSprites = [
          nessActor,
          jeffActor,
          damageToGraphic(rand(999)),
          nessAnimation,
          Composite([
            {tile: Tile(slashSheet, 0, 0, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 16, 0, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashSheet, 32, 0, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 48, 0, 16, 16), x: 0, y: 16}
          ]),
          Tile(slashSheet, 64, 0, 16, 16),
          Composite([
            {tile: Tile(slashSheet, 80, 0, 32, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 112, 0, 16, 16), x: 16, y: 16}
          ]),
          Composite([
            {tile: Tile(slashSheet, 0, 16, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 16, 16, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashSheet, 32, 16, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 48, 16, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashSheet, 64, 32, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 80, 32, 32, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashSheet, 112, 32, 16, 16), x: 0, y: 0},
            {tile: Tile(slashSheet, 0, 48, 16, 16), x: 0, y: 16}
          ]),
        ];

        var ts = 0;
		
        $('canvas').powerCanvas({init: function(_canvas) {
          canvas = _canvas;

          setInterval(function() {
            canvas.clear().fill("#8A8");

            // Gather Input


            testSprites[ts].draw(canvas, 50, 50);
            testSprites[ts].update();

            $.each(damageNumbers, function(i, damageNumber) {
              damageNumber.draw(canvas, 75 + 8*i, 8);
            });

            $.each(loadedComposites, function(i, composite) {
              composite.draw(canvas, 75 + 16*i, 32);
            });

          }, 100);
        }});
        
        $(document).keydown(function(e) {
          console.log(e);

          if(e.keyCode == 39) {
            action = Action.RIGHT;
          } else if(e.keyCode == 37) {
            action = Action.LEFT;
          } else if(e.keyCode == 38) {
            action = Action.UP;
          } else if (e.keyCode == 40) {
            action = Action.DOWN;
          } else if (e.keyCode == 13) {
            action = Action.ATTACK;
          } else if (e.keyCode == 8 || e.keyCode == 84) {
            action = Action.TELEPORT;
          }

          if(e.keyCode == 107) {
            ts++;
          } else if(e.keyCode == 109) {
            ts--;
          }
        });

        $(document).keyup(function(e) {
          action = "default";
        });
      });
    </script> 
  </body>
</html>
