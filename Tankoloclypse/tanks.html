<html>
  <head>
    <script src="jquery-1.3.2.js"></script>
    <script src="power_canvas.jquery.js"></script>
    <script src="strd6.js"></script>
    <script src="sprites.strd6.js"></script>
  </head>
  <body style="overflow:auto">   
    <canvas id="canvas" width="300" height="300">
      <p> Get a better browser</p>
    </canvas>
    <div id="panel" class="btn-slide" style="width: 300px; height:20px; background-color:black; cursor:pointer;"></div>
    <div id="panel" class="btn-slide" style="width:40px; height:10px; background-color:black; cursor:pointer;">
      <div style="font-size:9px; text-align:center; color:white; cursor:pointer;">inventory</div>
    </div>
    
    <img id="sprite" src="earthbound1.png" alt="earthbound"/>
    <img id="slashes" src="slashes.png" alt="chrono slashes"/>
    <img id="damageFont" src="damage_font.png" alt="damage font"/>

    <script>
      $(function() {
        $(".btn-slide").click(function(){
          $("#panel").slideToggle("fast");
          $(this).toggleClass("active");
        });
      
        var canvas;
        var action = "default";

        var Action = {
          RIGHT: 'r',
          LEFT: 'l',
          UP: 'u',
          DOWN: 'd'
        };

        var slashes = $("#slashes").get(0);
        var spriteSheet = $("#sprite").get(0);

        var nessAnimation = (function() {
          var tiles = [];
          var tileWidth = 18;
          var tileHeight = 28;

          for(var i = 0; i < 16; i++) {
            // Double to slow frame rate
            tiles[tiles.length] = Tile(spriteSheet, 8 + i*18, 16, tileWidth, tileHeight);
            tiles[tiles.length] = Tile(spriteSheet, 8 + i*18, 16, tileWidth, tileHeight);
          }

          return Animation(tiles);
        })();

        var nessActor = (function() {
          var moveSpeed = 2;

          var states = {};
          states['default'] = Tile(spriteSheet, 8 + 2*18, 16, 18, 28);
          states[Action.LEFT] = Animation([
            Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 4*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 5*18, 16, 18, 28)
          ]);
          states[Action.RIGHT] = Animation([
            Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 12*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 13*18, 16, 18, 28)
          ]);
          states[Action.UP] = Animation([
            Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 8*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 9*18, 16, 18, 28)
          ]);
          states[Action.DOWN] = Animation([
            Tile(spriteSheet, 8 + 0*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 0*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 16, 18, 28),
            Tile(spriteSheet, 8 + 1*18, 16, 18, 28)
          ]);

          return Actor(states, "default", 25, 25, function(state) {
            this.state(action);

            switch(action) {
              case Action.RIGHT:
                this.changePosition(moveSpeed, 0);
                break;
              case Action.LEFT:
                this.changePosition(-moveSpeed, 0);
                break;
              case Action.UP:
                this.changePosition(0, -moveSpeed);
                break;
              case Action.DOWN:
                this.changePosition(0, moveSpeed);
                break;
            }
          });
        })();

        var damageNumbers = (function() {
          var font = $("#damageFont").get(0);
          var nums = [];
          var size = 8

          // 0-9
          for(var i = 0; i <= 9; i++) {
            nums[i] = Tile(font, i * size, 0, size, size);
          }

          // MISS
          nums[i] = Tile(font, i * size, 0, 2*size, size);

          return nums;
        })();

        function damageToGraphic(damage) {
          var tiles = [];
          var pos = 0;
          var size = 8;

          while(damage > 0) {
            tiles.push({tile: damageNumbers[damage%10], x: pos*size, y: 0})
            damage = Math.floor(damage/10);
            pos--;
          }
          
          return Composite(tiles);
        }

        /*
        Sprite = function(image, baseX, baseY, cellWidth, cellHeight, frameCount)
        */
        var testSprites = [
          nessActor,
          damageToGraphic(rand(999)),
          nessAnimation,
          Composite([
            {tile: Tile(slashes, 0, 0, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 16, 0, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashes, 32, 0, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 48, 0, 16, 16), x: 0, y: 16}
          ]),
          Tile(slashes, 64, 0, 16, 16),
          Composite([
            {tile: Tile(slashes, 80, 0, 32, 16), x: 0, y: 0},
            {tile: Tile(slashes, 112, 0, 16, 16), x: 16, y: 16}
          ]),
          Composite([
            {tile: Tile(slashes, 0, 16, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 16, 16, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashes, 32, 16, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 48, 16, 16, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashes, 64, 32, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 80, 32, 32, 16), x: 0, y: 16}
          ]),
          Composite([
            {tile: Tile(slashes, 112, 32, 16, 16), x: 0, y: 0},
            {tile: Tile(slashes, 0, 48, 16, 16), x: 0, y: 16}
          ]),
        ];

        var ts = 0;
		    var hSteps = 0;
		    var vSteps = 0;
		    var hStart = 60;
		    var vStart = 60;
		    var alt = 6;
		    var attackSw = 0;
		
        var walkSprites = [
          /*
          Sprite = function(image, baseX, baseY, cellWidth, cellHeight, frameCount)
          */
          Tile(spriteSheet, 96, 16, 18, 28), /*Left facing foot extended*/
          Tile(spriteSheet, 80, 16, 18, 28), /*Left facing feet together*/
          Tile(spriteSheet, 224, 16, 18, 28), /*Right facing foot extended*/
          Tile(spriteSheet, 241, 16, 18, 28), /*Right facing feet together*/
          Tile(spriteSheet, 152, 16, 18, 28), /*Forward facing left foot forward*/
          Tile(spriteSheet, 170, 16, 18, 28), /*Right facing feet together */
          Tile(spriteSheet, 8, 16, 18, 28), /*Downward facing right foot forward*/
          Tile(spriteSheet, 26, 16, 18, 28) /*Downward facing left foot forward*/
        ];
		
        var Slashing = [
          Tile(slashes, 0, 30, 31, 15)
        ];
		
        $('canvas').powerCanvas({init: function(_canvas) {
          canvas = _canvas;

          function attack() {
    			  if (alt >= 0 && alt < 2) {
    			  Slashing[0].draw(canvas, (hStart - 20) + hSteps, (vStart + 10) + vSteps);	
    			  } else if (alt >= 2 && alt < 4) {
    			  Slashing[0].draw(canvas, (hStart + 5) + hSteps, (vStart + 10) + vSteps, {hFlip: true});
    			  } else if (alt >= 4 && alt < 6) {
    			  Slashing[0].draw(canvas, hStart + hSteps, (vStart - 10) + vSteps);
    			  } else if (alt >= 6 && alt < 8) {
    			  Slashing[0].draw(canvas, (hStart - 10) + hSteps, (vStart + 30) + vSteps, {hFlip: true, vFlip: true});
    		 	  }
    		  }          

          setInterval(function() {
            canvas.clear().fill("#8A8");

            // Gather Input


            testSprites[ts].draw(canvas, 50, 50);
            testSprites[ts].update();

            if (attackSw == 1) {
              attack();
            }
            walkSprites[alt].draw(canvas, hStart + hSteps, vStart + vSteps);
            attackSw = 0;

            $.each(damageNumbers, function(i, damageNumber) {
              damageNumber.draw(canvas, 75 + 8*i, 8);
            });

          }, 100);
        }});
        
        $(document).keydown(function(e) {
          console.log(e);

          function lwalk() {
            hSteps -= 4;
            alt += 1;
            alt = alt % 2;
          }

          function rwalk() {
            hSteps += 4;
            alt += 1;
            alt = alt % 2;
            alt += 2;
          }

          function uwalk() {
            vSteps -= 4;
            alt += 1;
            alt = alt % 2;
            alt += 4;
          }

          function dwalk() {
            vSteps += 4;
            alt += 1;
            alt = alt % 2;
            alt += 6;
          }

          function teleport() {
            hSteps = 0;
            vSteps = 0;
            hStart = rand(280);
            vStart = rand(280);
            alt = 6;
          }

          if(e.keyCode == 39) {
            action = Action.RIGHT;
            rwalk();
          } else if(e.keyCode == 37) {
            action = Action.LEFT;
            lwalk();
          } else if(e.keyCode == 38) {
            action = Action.UP;
            uwalk();
          } else if (e.keyCode == 40) {
            action = Action.DOWN;
            dwalk();
          } else if (e.keyCode == 13) {
            attackSw += 1;
          } else if (e.keyCode == 8) {
            teleport();
          }

          if(e.keyCode == 107) {
            ts++;
          } else if(e.keyCode == 109) {
            ts--;
          }
        });

        $(document).keyup(function(e) {
          action = "default";
        });
      });
    </script> 
  </body>
</html>
